<!doctype html>
<html lang='en-us'>
<head>
	<meta charset='utf-8' />
	<title>Orders App using MEAN Stack</title>
	<link rel='stylesheet' href='http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css' />
</head>
<body ng-app='OrdersApp' ng-controller='ApplicationCtrl'>

<nav class='navbar navbar-default'>
	<div class='container'>
		<ul class='nav navbar-nav'>
			<li><a href='/#/register'>Register</a></li>
			<li ng-if='!currentUser'><a href='/#/login'>Login</a></li>
			<li ng-if='currentUser' ng-click='logout()'><a href=''>Logout</a></li>
			<li ng-if='admin'><a href='/#/admin'>Admin</a></li>
		</ul>
	</div>
</nav>

<div class='container' ng-view></div>
<script src='https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0-beta.1/angular.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0-beta.1/angular-route.js'></script>
<script>
angular.module('OrdersApp', ['ngRoute']);

angular.module('OrdersApp').service('ShopService',['$http', function($http) {

	this.getItems = function() {
		return $http.get('/api/shop');
	}

}]);

angular.module('OrdersApp').config(function($routeProvider) {

	$routeProvider
	.when('/login', {
		controller: 'LoginCtrl',
		templateUrl: 'templates/login.html'
	})
	.when('/register', {
		controller: 'RegisterCtrl',
		templateUrl: 'templates/register.html'
	})
	.when('/shop', {
		controller: 'ShopCtrl',
		templateUrl: 'templates/shop.html'
	})
	.when('/admin', {
		controller: 'AdminCtrl',
		templateUrl: 'templates/admin.html'
	})
	.otherwise({ redirectTo: '/login' });

});

angular.module('OrdersApp').controller('ApplicationCtrl', ['$http','$location','$scope', function($http,$location, $scope) {

	$scope.$on('login', function(_, oResponse) {		
		$scope.admin = oResponse.data.bAdmin; 
		$scope.currentUser = oResponse.data.sUsername;
	});


	$scope.logout = function() {
		$http.delete('/api/user').then(function(oResponse) {
			$scope.currentUser = null;
			$location.path('/login');						
		});
	};

}]);

angular.module('OrdersApp').controller('AdminCtrl', ['ShopService','$scope','$http','$location', 
  function(ShopService,$scope,$http,$location) {

  	$scope.items = [];

	ShopService.getItems().then(function(oResponse) {
		$scope.items = oResponse.data.aItems.map(function(item) {
			item.tags = item.tags.join(',');
			return item;
		});

	});

	$scope.addItem = function() {
		$http.post('/api/admin/item', $scope.item).then(function(oResponse) {
			var item = oResponse.data.item;
			item.tags = item.tags.join(',');
			$scope.items.unshift(item);
		});
	};

}]);


angular.module('OrdersApp').controller('ShopCtrl', ['ShopService','$scope', '$http','$location', 
  function(ShopService,$scope,$http,$location) {
	
	ShopService.getItems().then(function(oResponse) {

		$scope.$emit('login', oResponse);

		if(oResponse.data.bSuccess) {
			$scope.items = oResponse.data.aItems.map(function(item) { 
				return Object.defineProperty(item,'quantity', { 
					value: 0, configurable: true, enumerable: true, writable: true 
				}); 
			});
		} else {
			$location.path('/');
		}
	}, function(oError) {
		$location.path('/');
	});

	$scope.plusOne = function(index) {
		$scope.items[index].quantity++;
	}

	$scope.zeroQuantity = function(index) {
		$scope.items[index].quantity = 0;
	}


	$scope.placeOrder = function() {
		var orderItems = $scope.items.filter(function(item) {
			return item.quantity > 0
		});

		if(orderItems.length > 0) {
			$http.post('/api/shop', orderItems).then(function(oResponse) {
				// console.log('placeOrder response:', oResponse);
				// lame, i know
				window.alert("Order placed");
			});
		}
		
	}

}]);

angular.module('OrdersApp').controller('LoginCtrl', ['$scope','$http','$location', function($scope,$http,$location) {

	$scope.login = function(username, password) {

		if(!username || !password) return;

		$http.post('/api/user/login', { 
			username: username,
			password: password 
		}).then(function(oResponse) {
			if(oResponse.data.bSuccess) {
				$scope.$emit('login', oResponse);
				$location.path('/shop');
			}
		});
	}

}]);

angular.module('OrdersApp').controller('RegisterCtrl', ['$scope','$http','$location', function($scope,$http,$location) {
	
	$scope.register = function() {

		$http.post('/api/user/register', $scope.user).then(function(oResponse) {
			
			if(oResponse.data.bSuccess) {
				$scope.$emit('login', oResponse);
				$location.path('/shop');
			}

		});
	}	

}]);




</script>
</body>
</html>